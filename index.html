<!DOCTYPE html>
<html>
<head>
    <title>SmartOffice Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map { width: 100%; height: 500px; margin-top: 20px; }
        .dashboard-cards { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { background: #f8f8f8; padding: 20px; border-radius: 8px; min-width: 180px; text-align: center; box-shadow: 0 2px 8px #eee; }
        .charts { display: flex; gap: 20px; flex-wrap: wrap; }
        .chart-container { background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px #eee; margin-bottom: 20px; }
    </style>
    <meta http-equiv="refresh" content="60">
</head>
<body>
    <h1>SmartOffice Entry Dashboard</h1>
    <div style="font-size:1.1em; color:#555; margin-bottom:12px;">
        Last updated (server): {{ last_update }}<br>
    </div>
    <div class="dashboard-cards">
        <div class="card">
            <h3>Total Entries Today</h3>
            <span id="total-entries" style="font-size:2em;">
                {{ total_entries }}
            </span>
        </div>
        <div class="card">
            <h3>Active Employees</h3>
            <span id="active-employees" style="font-size:2em;">210</span>
        </div>
        <div class="card">
            <h3>Entries vs Exits</h3>
            <canvas id="entryExitChart" width="180" height="120"></canvas>
        </div>
        <div class="card">
            <h3>Average Entries Per Week</h3>
            <span id="avg-entries-week" style="font-size:2em;">128</span>
        </div>
        <div class="card">
            <h3>Monthly Average Entries</h3>
            <span id="avg-entries-month" style="font-size:2em;">520</span>
        </div>
    </div>
    <div class="charts">
        <div class="chart-container">
            <h3>Entry Time Distribution</h3>
            <canvas id="entryTimeChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container" style="flex:1;">
            <h3>Entries (Last 7 Days)</h3>
            <canvas id="entriesWeekChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container" style="flex:1;">
            <h3>Building-wise Entry Split-up</h3>
            <table id="building-table" border="1" style="width:100%;margin-top:8px;">
                <thead>
                    <tr>
                        <th>Building Name</th>
                        <th>Entries</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted by JS -->
                </tbody>
            </table>
        </div>
    </div>
    <h2>Geospatial Map</h2>
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-geocoder/dist/ol-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-geocoder/dist/ol-geocoder.min.css" />
    <script>
        // Entries vs Exits
        new Chart(document.getElementById('entryExitChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Entries', 'Exits'],
                datasets: [{
                    data: {{ entry_exit_data | safe }},
                    backgroundColor: ['#4caf50', '#f44336']
                }]
            },
            options: { plugins: { legend: { display: false } }, cutout: '70%' }
        });

        // Entry Time Distribution
        new Chart(document.getElementById('entryTimeChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['7AM', '8AM', '9AM', '10AM', '11AM', '12PM'],
                datasets: [{
                    label: 'Entries',
                    data: {{ entry_time_data | safe }},
                    backgroundColor: '#2196f3'
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // Entries Last 7 Days
        new Chart(document.getElementById('entriesWeekChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                datasets: [{
                    label: 'Entries',
                    data: {{ entries_week_data | safe }},
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76,175,80,0.1)',
                    fill: true
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // --- Geospatial Map ---
        var geojsonData = {
            "type": "FeatureCollection",
            "features": [
                // --- Final campus boundary ---
                {
                    "type": "Feature",
                    "properties": { "name": "Campus Boundary" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.12038195164644, 12.944095754289364],
                                [80.12178707191794, 12.943583823225438],
                                [80.1225858246388, 12.944949885973756],
                                [80.1230742001058, 12.945794287225425],
                                [80.12248357009071, 12.946094461126393],
                                [80.12278646543416, 12.94653271945009],
                                [80.12144949043392, 12.946818072212736],
                                [80.12038195164644, 12.944095754289364]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "SDP1" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.121128158391, 12.944494856735645],
                                [80.12135489784856, 12.943933992234207],
                                [80.12188332510283, 12.944152443051237],
                                [80.12163954784154, 12.944709673237526],
                                [80.121128158391, 12.944494856735645]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "Cafeteria Block" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.12108721907646, 12.945145609087689],
                                [80.12071996352552, 12.944185218450286],
                                [80.12120505087125, 12.944001813855209],
                                [80.12098241034613, 12.944531058032439],
                                [80.12132322370536, 12.944685854839477],
                                [80.12108721907646, 12.945145609087689]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "Open air theatre" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.12163857882007, 12.944966103017705],
                                [80.12182632798721, 12.944530514940553],
                                [80.1219161298323, 12.944566693563118],
                                [80.12197684619429, 12.944633224514291],
                                [80.12201909923306, 12.944722133847748],
                                [80.12202597388182, 12.944803171098187],
                                [80.12199521044226, 12.944892574042115],
                                [80.12195661222677, 12.944947256090074],
                                [80.12189331365062, 12.944996369205754],
                                [80.12179799935564, 12.945008582401655],
                                [80.12171099023664, 12.944997384149161],
                                [80.12163857882007, 12.944966103017705]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "SDB2" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.12170488423243, 12.945812491795678],
                                [80.12120173342356, 12.945646415958365],
                                [80.12133234254281, 12.945258013950934],
                                [80.12118076084226, 12.945190247537496],
                                [80.12125208137076, 12.94501165080932],
                                [80.1219252790321, 12.945239255286523],
                                [80.12170488423243, 12.945812491795678]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "SDB3" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.12182840887544, 12.945774472430216],
                                [80.12204349731877, 12.945222254177452],
                                [80.12267482339666, 12.94543119349801],
                                [80.12228815708693, 12.945940098275443],
                                [80.12182840887544, 12.945774472430216]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "SDB4" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [80.1219398883494, 12.946601821786587],
                                [80.12178425991493, 12.946218300911227],
                                [80.12231503785404, 12.946054075557953],
                                [80.12263395647932, 12.94642398170977],
                                [80.1219398883494, 12.946601821786587]
                            ]
                        ]
                    }
                }
            ]
        };

        var buildings = [
            { name: "SDB 1 ", coordinates: [80.12150033864549, 12.944322993023448] },
            { name: "SDB 2 ", coordinates: [80.12153295878232, 12.945404649981654] },
            { name: "SDB 3 ", coordinates: [80.1222173560339, 12.945581768908951] },
            { name: "SDB 4", coordinates: [80.12217698550575, 12.946335730308618] },
            { name: "Cafeteria Block", coordinates: [80.12105062608151, 12.944679351061254] },
            { name: "Open air theatre ", coordinates: [80.12183540537654, 12.944906189241934] },
            { name: "Entry 1", coordinates: [80.12260855586908, 12.944850790697615], entry: true },
            { name: "Vehicle entryPoint", coordinates: [80.12125332163708, 12.946326430773581], entry: true },
            { name: "Vehicle exit Point", coordinates: [80.12304772992138, 12.945753187878623], exit: true },
            { name: "Exit Point", coordinates: [80.12256587227313, 12.944948369745845], exit: true },
            { name: "Vehicle exit Point 2", coordinates: [80.12043399158938, 12.9441929687611], exit: true } // <-- New point
        ];

        var features = buildings.map(function(building) {
            var feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(building.coordinates))
            });
            feature.set('name', building.name);
            if (building.entry) feature.set('entry', true);
            if (building.exit) feature.set('exit', true);
            return feature;
        });

        var vectorSource = new ol.source.Vector({
            features: features
        });

        var vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: function(feature) {
                if (feature.get('entry')) {
                    // Entry point: green marker with star
                    return [
                        new ol.style.Style({
                            image: new ol.style.Icon({
                                src: 'https://cdn.jsdelivr.net/npm/ol@latest/examples/data/icon.png',
                                scale: 0.7
                            }),
                            text: new ol.style.Text({
                                text: "★ " + feature.get('name'), // Star for entry
                                font: 'bold 13px Arial',
                                fill: new ol.style.Fill({ color: '#388e3c' }),
                                stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                                offsetY: -18
                            })
                        })
                    ];
                } else if (feature.get('exit')) {
                    // Exit point: red marker with cross
                    return [
                        new ol.style.Style({
                            image: new ol.style.Icon({
                                src: 'https://cdn.jsdelivr.net/npm/ol@latest/examples/data/exit.png',
                                scale: 0.7
                            }),
                            text: new ol.style.Text({
                                text: "✖ " + feature.get('name'), // Cross for exit
                                font: 'bold 13px Arial',
                                fill: new ol.style.Fill({ color: '#d32f2f' }),
                                stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                                offsetY: -18
                            })
                        })
                    ];
                } else {
                    // Default style for buildings
                    return [
                        new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 7,
                                fill: new ol.style.Fill({ color: '#2196f3' }),
                                stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                            }),
                            text: new ol.style.Text({
                                text: feature.get('name'),
                                font: 'bold 13px Arial',
                                fill: new ol.style.Fill({ color: '#333' }),
                                stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                                offsetY: -18
                            })
                        })
                    ];
                }
            }
        });

        var geojsonLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: new ol.format.GeoJSON().readFeatures(geojsonData, { featureProjection: 'EPSG:3857' })
            }),
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({ color: '#008000', width: 2 }),
                fill: new ol.style.Fill({ color: 'rgba(0,128,0,0.2)' })
            })
        });

        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({ source: new ol.source.OSM() }),
                geojsonLayer,
                vectorLayer
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([80.1215, 12.9458]),
                zoom: 18
            })
        });

        // Tooltip on mouseover for both points and polygons
        var tooltip = document.createElement('div');
        tooltip.style.position = 'absolute';
        tooltip.style.background = '#fff';
        tooltip.style.border = '1px solid #ccc';
        tooltip.style.padding = '4px 8px';
        tooltip.style.display = 'none';
        tooltip.style.pointerEvents = 'none';
        document.body.appendChild(tooltip);

        map.on('pointermove', function(evt) {
            var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });
            if (feature && feature.get('name')) {
                let label = feature.get('name');
                if (feature.get('entry')) {
                    label = "★ " + label;
                } else if (feature.get('exit')) {
                    label = "✖ " + label;
                }
                tooltip.innerHTML = label;
                tooltip.style.left = evt.originalEvent.pageX + 10 + 'px';
                tooltip.style.top = evt.originalEvent.pageY + 10 + 'px';
                tooltip.style.display = 'block';
            } else {
                tooltip.style.display = 'none';
            }
        });

        var geocoder = new Geocoder('nominatim', { provider: 'osm', lang: 'en-US', placeholder: 'Search for a location...' });
        map.addControl(geocoder);

        // Example entry counts for each building (replace with dynamic data if needed)
        var buildingEntries = {
            "SDB 1 ": 45,
            "SDB 2 ": 38,
            "SDB 3 ": 52,
            "SDB 4": 41,
            "Cafeteria Block": 120, // Most people move here
            "Open air theatre ": 16
        };

        var tableBody = document.getElementById('building-table').getElementsByTagName('tbody')[0];
        buildings.forEach(function(building) {
            // Only show main buildings, not entry/exit points
            if (
                building.name === "Entry 1" ||
                building.name === "Vehicle entryPoint" ||
                building.name === "Vehicle exit Point" ||
                building.name === "Exit Point" ||
                building.name === "Vehicle exit Point 2"
            ) {
                return; // Skip these
            }
            var row = document.createElement('tr');
            var nameCell = document.createElement('td');
            nameCell.textContent = building.name;
            var entryCell = document.createElement('td');
            entryCell.textContent = buildingEntries[building.name] || 0;

            // Highlight Cafeteria Block
            if (building.name === "Cafeteria Block") {
                row.style.backgroundColor = "#ffe082";
                row.style.fontWeight = "bold";
            }

            row.appendChild(nameCell);
            row.appendChild(entryCell);
            tableBody.appendChild(row);
        });

        // Example: Filter mobile points within office boundaries
        var mobilePoints = ee.FeatureCollection('users/your_username/mobile_traffic');
        var officeBoundaries = ee.FeatureCollection('users/your_username/office_blocks');
        var pointsInBlocks = mobilePoints.filterBounds(officeBoundaries);
        var trafficByBlock = officeBoundaries.map(function(block) {
          var points = mobilePoints.filterBounds(block.geometry());
          var totalTraffic = points.aggregate_sum('traffic_metric');
          return block.set('totalTraffic', totalTraffic);
        });

        // --- Date and Time (auto-updating) ---
        function updateDateTime() {
            var now = new Date();
            var formatted = now.toLocaleString();
            var dtElem = document.getElementById('datetime');
            if (dtElem) {
                dtElem.textContent = formatted;
            }
        }
        // Ensure the function runs after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        // --- Heatmap for building entries ---
        var heatmapFeatures = buildings
            .filter(function(building) {
                // Only main buildings, not entry/exit points
                return !building.entry && !building.exit;
            })
            .map(function(building) {
                var feature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat(building.coordinates))
                });
                // Use entry count as weight (normalize if needed)
                var entryCount = buildingEntries[building.name] || 0;
                feature.set('weight', entryCount);
                return feature;
            });

        var heatmapSource = new ol.source.Vector({
            features: heatmapFeatures
        });

        var heatmapLayer = new ol.layer.Heatmap({
            source: heatmapSource,
            blur: 25,
            radius: 18,
            weight: function(feature) {
                // Normalize weight (0-1) if needed
                var w = feature.get('weight');
                return Math.min(w / 120, 1); // 120 is max entry count for normalization
            }
        });

        // Add heatmapLayer to map
        map.addLayer(heatmapLayer);

        function refreshHeatmap() {
            // Fetch real data from backend (example endpoint: /api/building-entries)
            fetch('/api/building-entries')
                .then(response => response.json())
                .then(data => {
                    // Update buildingEntries with new data
                    Object.keys(data).forEach(function(name) {
                        buildingEntries[name] = data[name];
                    });

                    // Update heatmap features
                    heatmapFeatures.forEach(function(feature, idx) {
                        var building = buildings.filter(b => !b.entry && !b.exit)[idx];
                        var entryCount = buildingEntries[building.name] || 0;
                        feature.set('weight', entryCount);
                    });

                    // Force redraw
                    heatmapSource.changed();
                })
                .catch(error => {
                    console.error('Error fetching building entries:', error);
                });
        }

        // Refresh heatmap every 60 seconds
        setInterval(refreshHeatmap, 60000);

        // Optionally, call once on page load
        refreshHeatmap();
    </script>
</body>
</html>